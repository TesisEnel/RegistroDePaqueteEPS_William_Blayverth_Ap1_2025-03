@page "/reembolsos/create"
@inject NavigationManager NavManager
@inject UserManager<ApplicationUser> UserManager
@inject AuthenticationStateProvider AuthenticationStateProvider
@rendermode InteractiveServer

<SectionContent SectionName="TituloPagina">
    <h1>REEMBOLSOS</h1>
</SectionContent>

<div class="glass-container">

    <div>
        <h3 class="section-title">Registrar Solicitud</h3>

        <EditForm Model="NuevoReembolso" OnValidSubmit="GuardarReembolso">
            <DataAnnotationsValidator />

            <div class="form-grid">

                <div class="form-item">
                    <label>Asunto / Motivo</label>
                    <input type="text" class="input-box"
                           @bind-value="NuevoReembolso.Asunto"
                           placeholder="Ej: Paquete averiado..." />
                    <ValidationMessage For="@(() => NuevoReembolso.Asunto)" />
                </div>

                <div class="form-item">
                    <label>Tipo de Reclamo</label>
                    <select class="input-box" @bind="NuevoReembolso.Tipo">
                        <option value="">Seleccione...</option>
                        <option value="Dano">Daño de Mercancía</option>
                        <option value="Perdida">Pérdida de Paquete</option>
                        <option value="Retraso">Retraso en Entrega</option>
                        <option value="Facturacion">Error de Facturación</option>
                        <option value="Otro">Otro</option>
                    </select>
                    <ValidationMessage For="@(() => NuevoReembolso.Tipo)" />
                </div>

                <div class="form-item">
                    <label>Método de Reembolso</label>
                    <select class="input-box" @bind="NuevoReembolso.MetodoPago">
                        <option value="">Seleccione...</option>
                        <option value="Credito">Crédito a Cuenta</option>
                        <option value="Transferencia">Transferencia Bancaria</option>
                        <option value="Cheque">Cheque</option>
                    </select>
                    <ValidationMessage For="@(() => NuevoReembolso.MetodoPago)" />
                </div>

                <div class="form-item">
                    <label>Monto Solicitado (USD)</label>
                    <input type="number" class="input-box"
                           @bind-value="NuevoReembolso.MontoTotal"
                           placeholder="0.00" step="0.01" />
                    <ValidationMessage For="@(() => NuevoReembolso.MontoTotal)" />
                </div>

                <div class="form-item">
                    <label>Tracking Relacionado</label>
                    <input type="text" class="input-box"
                           @bind-value="NuevoReembolso.NumeroTrackingRef"
                           placeholder="Opcional..." />
                </div>

                @* Clase 'full-width' definida en el CSS local para expandir *@
                <div class="form-item full-width">
                    <label>Detalles / Observaciones</label>
                    <textarea class="input-box textarea-box"
                              @bind="NuevoReembolso.Observaciones"
                              placeholder="Describa lo sucedido..."></textarea>
                </div>
            </div>

            <div class="action-buttons">
                <a href="/reembolsos" class="btn-cancel">Cancelar</a>
                <button type="submit" class="btn-save">Enviar Solicitud</button>
            </div>

        </EditForm>
    </div>

</div>

@code {
    public Reembolso NuevoReembolso { get; set; } = new Reembolso();
    private ApplicationUser appUser;

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        if (user.Identity.IsAuthenticated)
        {
            appUser = await UserManager.GetUserAsync(user);
        }
    }

    private async Task GuardarReembolso()
    {
        if (appUser != null)
        {
            NuevoReembolso.ClienteId = appUser.Id;
            NuevoReembolso.FechaSolicitud = DateTime.Now;
            NuevoReembolso.Estado = "Pendiente";

            // var guardado = await reembolsosService.Guardar(NuevoReembolso);
            // if (guardado)
            // {
            //     NavManager.NavigateTo("/reembolsos");
            // }
        }
    }

    public class Reembolso
    {
        public int ReembolsoId { get; set; }
        public string ClienteId { get; set; }
        public DateTime FechaSolicitud { get; set; }
        [Required(ErrorMessage = "El asunto es obligatorio")]
        public string Asunto { get; set; }
        [Required(ErrorMessage = "El tipo es obligatorio")]
        public string Tipo { get; set; }
        [Required(ErrorMessage = "El método es obligatorio")]
        public string MetodoPago { get; set; }
        public string NumeroTrackingRef { get; set; }
        public string Observaciones { get; set; }
        [Required]
        [Range(0.01, double.MaxValue, ErrorMessage = "Monto inválido")]
        public decimal MontoTotal { get; set; }
        public string Estado { get; set; }
    }
}