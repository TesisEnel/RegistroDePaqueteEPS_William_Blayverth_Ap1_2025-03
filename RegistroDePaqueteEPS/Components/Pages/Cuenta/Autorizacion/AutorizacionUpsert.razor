@page "/cuenta/autorizados/upsert/{AutorizadoEntregaId:int}"

@using BlazorBootstrap
@using RegistroDePaqueteEPS.Extensors

@inject NavigationManager NavManager
@inject AutorizadosEntregaService autorizadosEntregaService
@inject UserManager<ApplicationUser> UserManager
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject ToastService toastService
@rendermode InteractiveServer


<SectionContent SectionName="TituloPagina">
    <h1>CUENTA</h1>
</SectionContent>

<div class="glass-container">

    <div class="sub-nav-bar">
        <NavLink class="sub-nav-item" href="/cuenta">Perfil</NavLink>
        <div class="separator"></div>
        <NavLink class="sub-nav-item" href="/cuenta/direcciones">Direcciones</NavLink>
        <div class="separator"></div>
        <NavLink class="sub-nav-item active" href="/cuenta/autorizados">Autorizados</NavLink>
    </div>

    <div class="form-content">
        <h3 class="section-title">@Estado Autorizado</h3>

        <EditForm Model="Autorizado" OnValidSubmit="GuardarAutorizado">
            <DataAnnotationsValidator />

            <div class="form-grid">
                <div class="form-item">
                    <label>Identificación</label>
                    <input type="text"
                           class="input-box"
                           @bind-value="Autorizado.Identificacion"
                           placeholder="000-0000000-0" />
                    <ValidationMessage For="@(() => Autorizado.Identificacion)" />
                </div>

                <div class="form-item">
                    <label>Nombre Completo</label>
                    <input type="text"
                           class="input-box"
                           @bind-value="Autorizado.Nombres"
                           placeholder="Nombre y Apellido" />
                    <ValidationMessage For="@(() => Autorizado.Nombres)" />
                </div>

                <div class="form-item">
                    <label>Teléfono</label>
                    <input type="text"
                           class="input-box"
                           @bind-value="Autorizado.Telefono"
                           placeholder="809-000-0000" />
                    <ValidationMessage For="@(() => Autorizado.Telefono)" />
                </div>

                <div class="form-item">
                    <label>Correo</label>
                    <input type="email"
                           class="input-box"
                           @bind-value="Autorizado.Correo"
                           placeholder="cliente@correo.com" />
                    <ValidationMessage For="@(() => Autorizado.Correo)" />
                </div>
            </div>

            <div class="action-buttons">
                <a href="/cuenta/autorizados" class="btn-cancel">Cancelar</a>
                <button type="submit" class="btn-save">Guardar</button>
            </div>

        </EditForm>
    </div>

</div>

@code {
    [Parameter] public int AutorizadoEntregaId { get; set; }
    public AutorizadosEntrega Autorizado { get; set; } = new AutorizadosEntrega();
    public string Estado { get; set; } = "Agregar";
    private ApplicationUser appUser;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            if (AutorizadoEntregaId > 0)
            {
                Estado = "Editar";
                Autorizado = await autorizadosEntregaService.Buscar(AutorizadoEntregaId);

                // Validación opcional: Si no encuentra el autorizado
                if (Autorizado == null)
                {
                    toastService.ShowError("No se encontró el autorizado solicitado.");
                    NavManager.NavigateTo("/cuenta/autorizados");
                }
            }
        }
        catch (Exception ex)
        {
            toastService.ShowError($"Error al cargar datos: {ex.Message}");
        }
    }

    private async Task GuardarAutorizado()
    {
        try
        {
            // Asignar ClienteId solo si es nuevo
            if (AutorizadoEntregaId == 0)
            {
                var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
                var userClaimsPrincipal = authState.User;

                if (userClaimsPrincipal.Identity.IsAuthenticated)
                {
                    appUser = await UserManager.GetUserAsync(userClaimsPrincipal);
                }

                if (appUser != null)
                {
                    Autorizado.ClienteId = appUser.Id;
                }
                else
                {
                    toastService.ShowError("No se pudo identificar al usuario actual.");
                    return;
                }
            }

            var modificado = await autorizadosEntregaService.Guardar(Autorizado);

            if (modificado)
            {
                string accion = AutorizadoEntregaId == 0 ? "creado" : "actualizado";
                toastService.ShowSuccess($"El autorizado ha sido {accion} correctamente.", "Éxito");
                NavManager.NavigateTo("/cuenta/autorizados");
            }
            else
            {
                toastService.ShowWarning("No se realizaron cambios o hubo un problema al guardar.");
            }
        }
        catch (Exception ex)
        {
            toastService.ShowError($"Ocurrió un error inesperado: {ex.Message}", "Error");
        }
    }
}