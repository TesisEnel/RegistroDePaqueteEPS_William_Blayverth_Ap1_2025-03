@page "/entregas"
@inject UserManager<ApplicationUser> UserManager
@inject AuthenticationStateProvider AuthenticationStateProvider
@rendermode InteractiveServer

<SectionContent SectionName="TituloPagina">
    <h1>REGISTRO DE ENTREGAS</h1>
</SectionContent>

<div class="glass-container">

    <div class="d-flex justify-content-between align-items-center mb-3">

        <div class="search-bar-container" style="margin-bottom: 0;">
            <div class="search-box">
                <i class="bi bi-search search-icon"></i>
                <input type="text" @bind="terminoBusqueda" @bind:event="oninput" placeholder="Buscar por Recibo, Cliente, Tracking..." />
            </div>
        </div>

        <a href="/entregas/create" class="btn-new">
            <i class="bi bi-box-seam"></i> Nueva Entrega
        </a>
    </div>

    <div class="table-header-row">
        <div class="col-cell">No. Recibo</div>
        <div class="vertical-line"></div>
        <div class="col-cell">Fecha</div>
        <div class="vertical-line"></div>
        <div class="col-cell wide">Cliente</div>
        <div class="vertical-line"></div>
        <div class="col-cell">Paquetes</div>
        <div class="vertical-line"></div>
        <div class="col-cell">Monto Cobrado</div>
        <div class="vertical-line"></div>
        <div class="col-cell">Realizado Por</div>
        <div class="vertical-line"></div>
        <div class="col-cell small">Detalles</div>
    </div>

    <div class="rows-container">
        @if (EntregasFiltradas.Count == 0)
        {
            <div class="data-row justify-content-center">
                <span class="text-muted">No se encontraron registros de entrega.</span>
            </div>
        }
        else
        {
            @foreach (var item in EntregasFiltradas)
            {
                <div class="data-row justify-content-center">

                    <div class="col-cell" style="font-weight: bold;">@item.NumeroRecibo</div>
                    <div class="vertical-line"></div>

                    <div class="col-cell">@item.FechaEntrega.ToString("dd/MM/yyyy hh:mm tt")</div>
                    <div class="vertical-line"></div>

                    <div class="col-cell wide">@item.NombreCliente</div>
                    <div class="vertical-line"></div>

                    <div class="col-cell">
                        <span class="badge-count">@item.CantidadPaquetes</span>
                    </div>
                    <div class="vertical-line"></div>

                    <div class="col-cell" style="color: #78BE42; font-weight: bold;">
                        RD$ @item.MontoTotal.ToString("N2")
                    </div>
                    <div class="vertical-line"></div>

                    <div class="col-cell">@item.UsuarioEmpleado</div>
                    <div class="vertical-line"></div>

                    <div class="col-cell small">
                        <button type="button" class="btn-icon edit" title="Ver Detalle"
                                @onclick="() => AbrirModalDetalle(item)">
                            <i class="bi bi-eye-fill"></i>
                        </button>
                    </div>
                </div>
            }
        }
    </div>

</div>

@* --- MODAL DE DETALLES (ESTILO AZUL CENTRADO) --- *@
@if (mostrarModal)
{
    <div class="modal-backdrop" @onclick="CerrarModal">
        <div class="modal-window-blue" @onclick:stopPropagation>

            <div class="eps-header">
                <img src="/Imagenes/EPS_Barra_Superior.png" alt="EPS Logo" />
                <button type="button" class="btn-close-x" @onclick="CerrarModal">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>

            <div class="eps-body-blue">
                <h3 style="border-bottom:1px solid rgba(255,255,255,0.3); padding-bottom:10px; margin-bottom:20px;">
                    Detalle de Entrega #@EntregaSeleccionada.NumeroRecibo
                </h3>

                @* Grid de Información General *@
                <div class="info-grid">
                    <div class="info-item">
                        <span class="label">Cliente:</span>
                        <span class="value">@EntregaSeleccionada.NombreCliente</span>
                    </div>
                    <div class="info-item">
                        <span class="label">Fecha Entrega:</span>
                        <span class="value">@EntregaSeleccionada.FechaEntrega.ToString("g")</span>
                    </div>
                    <div class="info-item">
                        <span class="label">Total Cobrado:</span>
                        <span class="value" style="color: #78BE42;">RD$ @EntregaSeleccionada.MontoTotal.ToString("N2")</span>
                    </div>
                    <div class="info-item">
                        <span class="label">Entregado Por:</span>
                        <span class="value">@EntregaSeleccionada.UsuarioEmpleado</span>
                    </div>
                </div>

                @* Tabla Interna de Paquetes Entregados (Letras Blancas) *@
                <h4 style="margin-top: 25px; color: white; border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 5px;">
                    Paquetes Entregados
                </h4>

                <div class="table-responsive">
                    <table class="custom-table-modal">
                        <thead>
                            <tr>
                                <th>Tracking</th>
                                <th>Contenido</th>
                                <th style="text-align: right;">Peso</th>
                                <th style="text-align: right;">Costo (USD)</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (EntregaSeleccionada.PaquetesDetalle != null && EntregaSeleccionada.PaquetesDetalle.Any())
                            {
                                @foreach (var paq in EntregaSeleccionada.PaquetesDetalle)
                                {
                                    <tr>
                                        <td>@paq.Tracking</td>
                                        <td>@paq.Contenido</td>
                                        <td style="text-align: right;">@paq.Peso lb</td>
                                        <td style="text-align: right;">$@paq.Costo.ToString("N2")</td>
                                    </tr>
                                }
                            }
                            else
                            {
                                <tr>
                                    <td colspan="4" style="text-align: center; opacity: 0.7;">No hay detalles disponibles.</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>

                @* Botón para Reimprimir Recibo (Opcional) *@
                <div class="modal-footer-actions" style="justify-content: space-between; align-items: flex-end;">
                    <button class="btn-status btn-process" @onclick="ImprimirRecibo">
                        <i class="bi bi-printer"></i> Imprimir Recibo
                    </button>
                    <button type="button" class="btn-blue-cancel" @onclick="CerrarModal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    public List<Entrega> ListaEntregas { get; set; } = new List<Entrega>();

    // --- BÚSQUEDA ---
    private string terminoBusqueda = "";

    // --- MODAL ---
    private bool mostrarModal = false;
    private Entrega EntregaSeleccionada = new Entrega();

    // LÓGICA DE FILTRADO
    private List<Entrega> EntregasFiltradas =>
        string.IsNullOrWhiteSpace(terminoBusqueda)
        ? ListaEntregas
        : ListaEntregas.Where(e =>
            (e.NumeroRecibo?.Contains(terminoBusqueda, StringComparison.OrdinalIgnoreCase) ?? false) ||
            (e.NombreCliente?.Contains(terminoBusqueda, StringComparison.OrdinalIgnoreCase) ?? false)
          ).ToList();

    protected override async Task OnInitializedAsync()
    {
        await CargarEntregas();
    }

    private async Task CargarEntregas()
    {
        // Simulación o llamada al servicio real
        // ListaEntregas = await entregasService.Listar();
        ListaEntregas = new List<Entrega>(); // Placeholder para evitar error
    }

    private async Task AbrirModalDetalle(Entrega item)
    {
        // Cargar detalles completos si es necesario
        // EntregaSeleccionada = await entregasService.Buscar(item.EntregaId);
        EntregaSeleccionada = item;
        mostrarModal = true;
    }

    private void CerrarModal()
    {
        mostrarModal = false;
    }

    private void ImprimirRecibo()
    {
        // Lógica de impresión
    }

    // --- CLASES AUXILIARES (MODELOS) ---
   
        public int EntregaId { get; set; }
        public string NumeroRecibo { get; set; }
        public DateTime FechaEntrega { get; set; }
        public string NombreCliente { get; set; }
        public string UsuarioEmpleado { get; set; }
        public decimal MontoTotal { get; set; }
        public int CantidadPaquetes => PaquetesDetalle?.Count ?? 0;
        public List<PaqueteEntregaDetalle> PaquetesDetalle { get; set; } = new();
   

    public class PaqueteEntregaDetalle
    {
        public string Tracking { get; set; }
        public string Contenido { get; set; }
        public double Peso { get; set; }
        public decimal Costo { get; set; }
    }
}