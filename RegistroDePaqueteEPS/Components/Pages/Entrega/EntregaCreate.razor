@page "/entregas/create"
@inject NavigationManager NavManager
@inject UserManager<ApplicationUser> UserManager
@inject AuthenticationStateProvider AuthenticationStateProvider
@rendermode InteractiveServer

<SectionContent SectionName="TituloPagina">
    <h1>REGISTRO DE ENTREGAS</h1>
</SectionContent>

<div class="glass-container">

    <div>
        <h3 class="section-title">Nueva Transacción de Entrega</h3>

        <EditForm Model="NuevaEntrega" OnValidSubmit="GuardarEntrega">
            <DataAnnotationsValidator />

            @* --- 1. DATOS GENERALES DE LA ENTREGA --- *@
            <div class="form-grid">

                <div class="form-item">
                    <label>Cliente / Retirado Por</label>
                    <input type="text" class="input-box"
                           @bind-value="NuevaEntrega.NombreCliente"
                           placeholder="Nombre de quien retira..." />
                    <ValidationMessage For="@(() => NuevaEntrega.NombreCliente)" />
                </div>

                <div class="form-item">
                    <label>Método de Pago</label>
                    <select class="input-box" @bind="MetodoPagoSeleccionado">
                        <option value="Efectivo">Efectivo</option>
                        <option value="Tarjeta">Tarjeta de Crédito/Débito</option>
                        <option value="Transferencia">Transferencia</option>
                        <option value="Credito">Crédito (Cuenta)</option>
                    </select>
                </div>

                <div class="form-item">
                    <label>No. Recibo (Auto)</label>
                    <input type="text" class="input-box" value="@ReciboGenerado" readonly style="background-color: rgba(255,255,255,0.7); color: #555;" />
                </div>

                <div class="form-item">
                    <label>Nota / Comentario</label>
                    <input type="text" class="input-box"
                           @bind-value="NuevaEntrega.Notas"
                           placeholder="Opcional..." />
                </div>
            </div>

            @* --- 2. SECCIÓN DE PAQUETES A ENTREGAR (DETALLE) --- *@
            <div class="detail-section">
                <h4 class="detail-title">Escanear Paquetes</h4>

                @* Inputs para agregar (Simula escáner) *@
                <div class="detail-inputs-row">
                    <div class="form-item" style="flex: 2;">
                        <label>Tracking / Paquete ID</label>
                        <div class="input-group-scan">
                            <input type="text" class="input-box small-input"
                                   @bind="PaqueteTemporal.Tracking"
                                   placeholder="Escanee el código aquí..." />
                            @* Botón de lupa opcional para simular búsqueda *@
                            <button type="button" class="btn-scan-icon"><i class="bi bi-upc-scan"></i></button>
                        </div>
                    </div>

                    <div class="form-item">
                        <label>Contenido</label>
                        <input type="text" class="input-box small-input"
                               @bind="PaqueteTemporal.Contenido"
                               placeholder="Ej: Ropa" />
                    </div>

                    <div class="form-item">
                        <label>Costo (RD$)</label>
                        <input type="number" class="input-box small-input"
                               @bind="PaqueteTemporal.Costo"
                               placeholder="0.00" step="0.01" />
                    </div>

                    <div class="form-item" style="justify-content: flex-end;">
                        <button type="button" class="btn-add" @onclick="AgregarPaquete">
                            <i class="bi bi-plus-lg"></i> Agregar
                        </button>
                    </div>
                </div>

                @* Tabla de paquetes agregados *@
                <div class="table-responsive mt-3">
                    <table class="custom-table">
                        <thead>
                            <tr>
                                <th>Tracking</th>
                                <th>Contenido</th>
                                <th style="text-align: right;">Peso</th>
                                <th style="text-align: right;">Importe</th>
                                <th style="text-align: center;">Acción</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (ListaPaquetes.Any())
                            {
                                @foreach (var item in ListaPaquetes)
                                {
                                    <tr>
                                        <td>@item.Tracking</td>
                                        <td>@item.Contenido</td>
                                        <td style="text-align: right;">@item.Peso.ToString("N2") lb</td>
                                        <td style="text-align: right;">RD$ @item.Costo.ToString("N2")</td>
                                        <td style="text-align: center;">
                                            <button type="button" class="btn-icon-small delete" @onclick="() => RemoverPaquete(item)">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </td>
                                    </tr>
                                }
                            }
                            else
                            {
                                <tr>
                                    <td colspan="5" class="text-center text-muted" style="color: rgba(255,255,255,0.7) !important;">
                                        No se han escaneado paquetes.
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>

                @* Resumen de Totales *@
                <div class="totals-row">
                    <div class="total-item">
                        <span>Paquetes:</span> <strong>@ListaPaquetes.Count</strong>
                    </div>
                    <div class="total-item">
                        <span>Peso Total:</span> <strong>@PesoTotal.ToString("N2") lb</strong>
                    </div>
                    <div class="total-item big-total">
                        <span>Total a Cobrar:</span> <strong>RD$ @NuevaEntrega.MontoTotal.ToString("N2")</strong>
                    </div>
                </div>
            </div>

            @* --- BOTONES DE ACCIÓN --- *@
            <div class="action-buttons">
                <a href="/entregas" class="btn-cancel">Cancelar</a>
                <button type="submit" class="btn-save">Procesar Entrega</button>
            </div>

        </EditForm>
    </div>

</div>

@code {
    public Entrega NuevaEntrega { get; set; } = new Entrega();

    // Lógica local para el Detalle
    public List<PaqueteEntregaDetalle> ListaPaquetes { get; set; } = new List<PaqueteEntregaDetalle>();
    public PaqueteEntregaDetalle PaqueteTemporal { get; set; } = new PaqueteEntregaDetalle();

    private string MetodoPagoSeleccionado = "Efectivo";
    private string ReciboGenerado = "REC-" + DateTime.Now.ToString("yyMMddHHmm"); // Simulación
    private double PesoTotal = 0;
    private ApplicationUser appUser;

    // Clases auxiliares para la vista
    public class Entrega
    {
        public string NumeroRecibo { get; set; }
        public string NombreCliente { get; set; }
        public string UsuarioEmpleado { get; set; }
        public string Notas { get; set; }
        public decimal MontoTotal { get; set; }
        public DateTime FechaEntrega { get; set; }
    }
    public class PaqueteEntregaDetalle
    {
        public string Tracking { get; set; }
        public string Contenido { get; set; }
        public double Peso { get; set; } = 1.0; // Default simulado
        public decimal Costo { get; set; }
    }

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        if (user.Identity.IsAuthenticated)
        {
            appUser = await UserManager.GetUserAsync(user);
            NuevaEntrega.UsuarioEmpleado = appUser?.UserName ?? "Admin";
        }
        NuevaEntrega.NumeroRecibo = ReciboGenerado;
    }

    private void AgregarPaquete()
    {
        if (string.IsNullOrWhiteSpace(PaqueteTemporal.Tracking)) return;

        // En un caso real, aquí buscarías el paquete en la DB para traer su peso y costo real
        // Aquí usamos lo que el usuario escriba o valores por defecto

        ListaPaquetes.Add(new PaqueteEntregaDetalle
        {
            Tracking = PaqueteTemporal.Tracking,
            Contenido = string.IsNullOrEmpty(PaqueteTemporal.Contenido) ? "Paquete General" : PaqueteTemporal.Contenido,
            Peso = PaqueteTemporal.Peso > 0 ? PaqueteTemporal.Peso : 1.0, // Peso simulado si es 0
            Costo = PaqueteTemporal.Costo
        });

        PaqueteTemporal = new PaqueteEntregaDetalle(); // Limpiar inputs
        RecalcularTotales();
    }

    private void RemoverPaquete(PaqueteEntregaDetalle item)
    {
        ListaPaquetes.Remove(item);
        RecalcularTotales();
    }

    private void RecalcularTotales()
    {
        NuevaEntrega.MontoTotal = ListaPaquetes.Sum(x => x.Costo);
        PesoTotal = ListaPaquetes.Sum(x => x.Peso);
    }

    private async Task GuardarEntrega()
    {
        if (ListaPaquetes.Any() && !string.IsNullOrEmpty(NuevaEntrega.NombreCliente))
        {
            NuevaEntrega.FechaEntrega = DateTime.Now;

            // Lógica de guardado del servicio:
            // await entregasService.Guardar(NuevaEntrega, ListaPaquetes);

            NavManager.NavigateTo("/entregas");
        }
    }
}