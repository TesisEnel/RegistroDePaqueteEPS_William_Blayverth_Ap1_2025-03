@page "/delivery/create"
@inject NavigationManager NavManager
@inject UserManager<ApplicationUser> UserManager
@inject AuthenticationStateProvider AuthenticationStateProvider
@rendermode InteractiveServer

<SectionContent SectionName="TituloPagina">
    <h1>DELIVERY</h1>
</SectionContent>

<div class="glass-container">

    <div>
        <h3 class="section-title">Solicitar Nuevo Delivery</h3>

        <EditForm Model="NuevoDelivery" OnValidSubmit="GuardarDelivery">
            <DataAnnotationsValidator />

            @* --- 1. DATOS DE ENTREGA --- *@
            <div class="form-grid">

                <div class="form-item">
                    <label>Dirección de Entrega</label>
                    <input type="text" class="input-box"
                           @bind-value="NuevoDelivery.DireccionCompleta"
                           placeholder="Calle, Número, Sector..." />
                    <ValidationMessage For="@(() => NuevoDelivery.DireccionCompleta)" />
                </div>

                <div class="form-item">
                    <label>Teléfono de Contacto</label>
                    <input type="text" class="input-box"
                           @bind-value="NuevoDelivery.TelefonoContacto"
                           placeholder="(809) 000-0000" />
                    <ValidationMessage For="@(() => NuevoDelivery.TelefonoContacto)" />
                </div>

                @* Ocupa todo el ancho *@
                <div class="form-item full-width">
                    <label>Referencia / Notas</label>
                    <textarea class="input-box textarea-box"
                              @bind="NuevoDelivery.Notas"
                              placeholder="Ej: Casa de dos niveles, portón blanco..."></textarea>
                </div>
            </div>

            @* --- 2. SECCIÓN DE PAQUETES A ENTREGAR (DETALLE) --- *@
            <div class="detail-section">
                <h4 class="detail-title">Paquetes a Incluir</h4>

                @* Inputs para agregar paquetes *@
                <div class="detail-inputs-row">
                    <div class="form-item" style="flex: 2;">
                        <label>Tracking / Descripción</label>
                        <input type="text" class="input-box small-input"
                               @bind="PaqueteTemporal.Tracking"
                               placeholder="Ej: 1Z999... o Zapatos" />
                    </div>

                    <div class="form-item">
                        <label>Peso (Lb)</label>
                        <input type="number" class="input-box small-input"
                               @bind="PaqueteTemporal.Peso"
                               placeholder="0.00" step="0.01" />
                    </div>

                    <div class="form-item" style="justify-content: flex-end;">
                        <button type="button" class="btn-add" @onclick="AgregarPaquete">
                            <i class="bi bi-plus-circle"></i> Agregar
                        </button>
                    </div>
                </div>

                @* Tabla de paquetes *@
                <div class="table-responsive mt-3">
                    <table class="custom-table">
                        <thead>
                            <tr>
                                <th>Descripción / Tracking</th>
                                <th style="text-align: right;">Peso</th>
                                <th style="text-align: center;">Opciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (ListaPaquetes.Any())
                            {
                                @foreach (var item in ListaPaquetes)
                                {
                                    <tr>
                                        <td>@item.Tracking</td>
                                        <td style="text-align: right;">@item.Peso.ToString("N2") lb</td>
                                        <td style="text-align: center;">
                                            <button type="button" class="btn-icon-small delete" @onclick="() => RemoverPaquete(item)">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </td>
                                    </tr>
                                }
                            }
                            else
                            {
                                <tr>
                                    <td colspan="3" class="text-center text-muted" style="color: rgba(255,255,255,0.7) !important;">
                                        Agregue los paquetes que desea recibir.
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>

                @* Resumen de Totales *@
                <div class="totals-row">
                    <div class="total-item">
                        <span>Cant. Paquetes:</span> <strong>@ListaPaquetes.Count</strong>
                    </div>
                    <div class="total-item">
                        <span>Peso Total:</span> <strong>@NuevoDelivery.PesoTotal.ToString("N2") lb</strong>
                    </div>
                    <div class="total-item">
                        <span>Costo Envío:</span> <strong style="color: #78BE42; font-size: 1.3rem;">RD$ @NuevoDelivery.CostoTotal.ToString("N2")</strong>
                    </div>
                </div>
            </div>

            @* --- BOTONES DE ACCIÓN --- *@
            <div class="action-buttons">
                <a href="/delivery" class="btn-cancel">Cancelar</a>
                <button type="submit" class="btn-save">Solicitar Delivery</button>
            </div>

        </EditForm>
    </div>

</div>

@code {
    public DeliverySolicitud NuevoDelivery { get; set; } = new DeliverySolicitud();

    // Lógica local para el Detalle
    public List<PaqueteSimple> ListaPaquetes { get; set; } = new List<PaqueteSimple>();
    public PaqueteSimple PaqueteTemporal { get; set; } = new PaqueteSimple();
    private ApplicationUser appUser;

    // Clases auxiliares para que compile la vista
    public class DeliverySolicitud
    {
        public string DireccionCompleta { get; set; }
        public string TelefonoContacto { get; set; }
        public string Notas { get; set; }
        public double PesoTotal { get; set; }
        public decimal CostoTotal { get; set; }
        public string ClienteId { get; set; }
        public DateTime FechaSolicitud { get; set; }
        public string Estado { get; set; }
    }
    public class PaqueteSimple { public string Tracking { get; set; } public double Peso { get; set; } }

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;
        if (user.Identity.IsAuthenticated) appUser = await UserManager.GetUserAsync(user);
    }

    private void AgregarPaquete()
    {
        if (string.IsNullOrWhiteSpace(PaqueteTemporal.Tracking)) return;

        ListaPaquetes.Add(new PaqueteSimple
        {
            Tracking = PaqueteTemporal.Tracking,
            Peso = PaqueteTemporal.Peso
        });

        PaqueteTemporal = new PaqueteSimple();
        RecalcularTotales();
    }

    private void RemoverPaquete(PaqueteSimple item)
    {
        ListaPaquetes.Remove(item);
        RecalcularTotales();
    }

    private void RecalcularTotales()
    {
        NuevoDelivery.PesoTotal = ListaPaquetes.Sum(x => x.Peso);
        // Lógica de costo simple: Base 150 + 50 por paquete extra (ejemplo)
        NuevoDelivery.CostoTotal = ListaPaquetes.Count > 0 ? 150 + ((ListaPaquetes.Count - 1) * 50) : 0;
    }

    private async Task GuardarDelivery()
    {
        if (appUser != null && ListaPaquetes.Any())
        {
            NuevoDelivery.ClienteId = appUser.Id;
            NuevoDelivery.FechaSolicitud = DateTime.Now;
            NuevoDelivery.Estado = "Pendiente";

            // Aquí llamarías a tu servicio real:
            // await deliveryService.Guardar(NuevoDelivery, ListaPaquetes);

            NavManager.NavigateTo("/delivery");
        }
    }
}