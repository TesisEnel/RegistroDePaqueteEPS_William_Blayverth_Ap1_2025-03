@inherits LayoutComponentBase
@using MudBlazor
@inject AuthenticationStateProvider AuthStateProvider
@inject UserManager<ApplicationUser> UserManager
@inject NavigationManager NavManager

<MudPopoverProvider />
<MudDialogProvider />
<MudSnackbarProvider />

<div class="page dashboard-scale">

    <header class="top-header">
        <div class="logo-container">
            <img src="/Imagenes/EPS_Barra_Superior.png" alt="EPS Logo" class="logo-img" />
        </div>

        <div class="header-title-container">
            <SectionOutlet SectionName="TituloPagina" />
        </div>

        <AuthorizeView Roles="Cliente">
            <Authorized>
                <div class="user-header-info">
                    <div class="text-right">
                        <span class="user-name-text">@NombreUsuario</span>
                        <br />
                        <span class="user-code-text">@CodigoEPS</span>
                    </div>
                    <i class="bi bi-person-fill user-header-icon"></i>
                </div>
            </Authorized>
        </AuthorizeView>
    </header>

    <div class="main-container">
        <main class="content">
            <div class="content-body">
                @Body
            </div>

            <div class="layout-footer">
                <div class="copyright-text">EPS, Todos los Derechos Reservados</div>
                <a href="#" class="footer-link">Términos y condiciones</a>
            </div>
        </main>

        <aside class="sidebar-container">
            <NavMenu />
        </aside>
    </div>
</div>

@code {
    private string NombreUsuario = "Cargando...";
    private string CodigoEPS = "---";

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthStateProvider.GetAuthenticationStateAsync();
        var userPrincipal = authState.User;

        if (userPrincipal.Identity != null && userPrincipal.Identity.IsAuthenticated)
        {
            var appUser = await UserManager.GetUserAsync(userPrincipal);
            if (appUser != null)
            {
                NombreUsuario = appUser.NombreCompleto ?? userPrincipal.Identity.Name;
                CodigoEPS = appUser.UserName;
            }
        }
    }
}